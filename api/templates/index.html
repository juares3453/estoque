<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <title>Estoque de Mercadorias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  </head>

  <body class="bg-light">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="/">üì¶ Estoque</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="/adicionar">‚ûï Movimenta√ß√µes</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/fornecedores">üè¢ Fornecedores</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/relatorios">üìä Relat√≥rios</a>
          </li>
           <li class="nav-item">
            <a class="nav-link" href="/cirurgias">üè• Cirurgias</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/informacoes">üìã Log</a>
          </li>
          {% if usuario and usuario.role == 'gerente' %}
          <li class="nav-item">
            <a class="nav-link" href="/grupos">üóÇÔ∏è Grupos</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/usuarios">üë• Usu√°rios</a>
          </li>
          {% endif %}
        </ul>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <span class="navbar-text mr-3">
              üë§ <strong>{{ usuario.username }}</strong> ({{ usuario.role }})
            </span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/logout">üö™ Sair</a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Conte√∫do Principal -->
    <div class="container-fluid mt-4">
      <h1 class="mb-4 text-center">Estoque de Mercadorias</h1>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="mb-4">
        {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="close"
            data-dismiss="alert"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <!-- Barra de Pesquisa -->
      <div class="card mb-3">
        <div class="card-body">
          <form class="form-inline">
            <input
              type="text"
              id="pesquisa"
              class="form-control w-100"
              placeholder="üîç Pesquisar mercadoria por c√≥digo ou nome..."
            />
          </form>
        </div>
      </div>

      <!-- Tabela de Mercadorias -->
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table
              class="table table-bordered table-striped mb-0"
              id="tabela-mercadorias"
            >
              <thead class="thead-dark">
                <tr>
                  <th>ID</th>
                  <th>Grupo</th>
                  <th>Nome</th>
                  <th>Quantidade</th>
                  <th>Status</th>
                  <th>Descri√ß√£o</th>
                  <th>Pre√ßo</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="resultados">
                {% for mercadoria in mercadorias %}
                <tr>
                  <td>{{ mercadoria.id }}</td>
                  <td>{{ mercadoria.grupo }}</td>
                  <td>{{ mercadoria.nome }}</td>
                  <td>{{ mercadoria.quantidade }}</td>
                  <td>
                    {% if mercadoria.quantidade > 0 %}
                    <span class="text-success">Em estoque ‚Äî {{ mercadoria.quantidade }} restantes</span>
                    {% else %}
                    <span class="text-danger">Sa√≠da ‚Äî 0 restantes</span>
                    {% endif %}
                  </td>
                  <td>{{ mercadoria.descricao }}</td>
                  <td>R$ {{ mercadoria.preco }}</td>
                  <td>
                    <a href="/editar/{{ mercadoria.id }}" class="btn btn-warning btn-sm">Editar</a>
                    <a href="/excluir/{{ mercadoria.id }}" class="btn btn-danger btn-sm">Excluir</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        var fornecedores = {{ fornecedores_json|tojson }};

        function fornecedoresOptionsHtml() {
          var s = '<select class="form-control form-control-sm fornecedor-select d-inline-block ml-2" style="width:auto"><option value="">Fornecedor</option>';
          fornecedores.forEach(function(f){ s += '<option value="'+f.id+'">'+(f.nome||f.id)+'</option>'; });
          s += '</select>';
          return s;
        }

        $("#pesquisa").on("input", function () {
          var query = $(this).val();
          $.ajax({
            url: "/buscar_ajax",
            type: "GET",
            data: { query: query },
            success: function (data) {
              $("#resultados").empty();
                if (data.length > 0) {
                data.forEach(function (mercadoria) {
                  $("#resultados").append(
                    "<tr>" +
                      "<td>" + mercadoria.id + "</td>" +
                      "<td>" + mercadoria.grupo + "</td>" +
                      "<td>" + mercadoria.nome + "</td>" +
                      "<td>" + mercadoria.quantidade + "</td>" +
                      "<td>" + (mercadoria.quantidade > 0 ? ('<span class=\"text-success\">Em estoque ‚Äî ' + mercadoria.quantidade + ' restantes</span>') : '<span class=\"text-danger\">Sa√≠da ‚Äî 0 restantes</span>') + "</td>" +
                      "<td>" + mercadoria.descricao + "</td>" +
                      "<td>R$ " + mercadoria.preco.toFixed(2) + "</td>" +
                      "<td>" +
                      '<a href="/editar/' + mercadoria.id + '" class="btn btn-warning btn-sm">Editar</a> ' +
                      '<a href="/excluir/' + mercadoria.id + '" class="btn btn-danger btn-sm">Excluir</a>' +
                      fornecedoresOptionsHtml() +
                      ' <button class="btn btn-info btn-sm btn-nova-nf">Nova NF</button>' +
                      ' <button class="btn btn-primary btn-sm btn-ver-nfs">Ver NFs</button>' +
                      "</td>" +
                    "</tr>"
                  );
                });
              } else {
                $("#resultados").append(
                  '<tr><td colspan="8" class="text-center">Nenhuma mercadoria encontrada</td></tr>'
                );
              }
            },
          });
          $("#ver_nfs_btn").on('click', function(e){
            e.preventDefault();
            var id = $('#fornecedor_select').val();
            if(!id){
              alert('Selecione um fornecedor para ver as Notas Fiscais.');
              return;
            }
            window.location.href = '/fornecedores/' + id + '/nfs';
          });

        // Delegated handlers for per-row NF actions
        $(document).on('click', '.btn-nova-nf', function(e){
          e.preventDefault();
          var sel = $(this).closest('td').find('.fornecedor-select');
          var id = sel.val();
          if(!id){ alert('Selecione um fornecedor primeiro.'); return; }
          window.location.href = '/fornecedores/' + id + '/nova_nf';
        });

        $(document).on('click', '.btn-ver-nfs', function(e){
          e.preventDefault();
          var sel = $(this).closest('td').find('.fornecedor-select');
          var id = sel.val();
          if(!id){ alert('Selecione um fornecedor primeiro.'); return; }
          window.location.href = '/fornecedores/' + id + '/nfs';
        });
        });
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html>
