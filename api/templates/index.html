<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <title>Estoque de Mercadorias da Essence</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  </head>

  <body class="bg-light">
    <div class="container mt-4">
      <h1 class="mb-4">Estoque de Mercadorias</h1>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="mb-4">
        {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="close"
            data-dismiss="alert"
            aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <div class="card mb-4">
        <div class="card-body d-flex justify-content-between">
          <form class="form-inline">
            <input
              type="text"
              id="pesquisa"
              class="form-control mr-2"
              placeholder="Pesquisar mercadoria"
            />
          </form>
          <div>
            <a href="/movimentacoes" class="btn btn-info">Ver Movimentações</a>
            <a href="/fornecedores" class="btn btn-info">Ver Fornecedores</a>
            <a href="/adicionar" class="btn btn-success ml-2"
              >Adicionar Mercadoria</a
            >
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <table
            class="table table-bordered table-striped"
            id="tabela-mercadorias"
          >
            <thead class="thead-dark">
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Descrição</th>
                <th>Preço</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="resultados">
              {% for mercadoria in mercadorias %}
              <tr>
                <td>{{ mercadoria.id }}</td>
                <td>{{ mercadoria.nome }}</td>
                <td>{{ mercadoria.quantidade }}</td>
                <td>{{ mercadoria.descricao }}</td>
                <td>R$ {{ mercadoria.preco }}</td>
                <td>
                  <a
                    href="/editar/{{ mercadoria.id }}"
                    class="btn btn-warning btn-sm"
                    >Editar</a
                  >
                  <a
                    href="/excluir/{{ mercadoria.id }}"
                    class="btn btn-danger btn-sm"
                    >Excluir</a
                  >
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        $("#pesquisa").on("input", function () {
          var query = $(this).val();
          $.ajax({
            url: "/buscar_ajax",
            type: "GET",
            data: { query: query },
            success: function (data) {
              $("#resultados").empty();
              if (data.length > 0) {
                data.forEach(function (mercadoria) {
                  $("#resultados").append(
                    "<tr>" +
                      "<td>" +
                      mercadoria.id +
                      "</td>" +
                      "<td>" +
                      mercadoria.nome +
                      "</td>" +
                      "<td>" +
                      mercadoria.quantidade +
                      "</td>" +
                      "<td>" +
                      mercadoria.descricao +
                      "</td>" +
                      "<td>R$ " +
                      mercadoria.preco.toFixed(2) +
                      "</td>" +
                      "<td>" +
                      '<a href="/editar/' +
                      mercadoria.id +
                      '" class="btn btn-warning btn-sm">Editar</a> ' +
                      '<a href="/excluir/' +
                      mercadoria.id +
                      '" class="btn btn-danger btn-sm">Excluir</a>' +
                      "</td>" +
                      "</tr>"
                  );
                });
              } else {
                $("#resultados").append(
                  '<tr><td colspan="6" class="text-center">Nenhuma mercadoria encontrada</td></tr>'
                );
              }
            },
          });
        });
      });
    </script>
  </body>
</html>
